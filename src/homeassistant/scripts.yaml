# =============================================================================
# Home Assistant - Scripts de SeguranÃ§a
# Home Security DIY
# =============================================================================

# ---------------------------------------------------------------------------
# BotÃ£o de PÃ¢nico
# Ativa TUDO: alarme, sirenes, luzes, notificaÃ§Ã£o de emergÃªncia.
# PRD: RF-027 (PRD_PERIMETER_URBAN_HOUSE), RF-009 (PRD_SENSORS_AND_ALARMS_PLATFORM)
# ---------------------------------------------------------------------------
panic_button:
  alias: "ðŸš¨ BotÃ£o de PÃ¢nico"
  description: "Ativa alarme, sirenes, luzes e envia notificaÃ§Ã£o de emergÃªncia"
  icon: mdi:alert-octagon
  mode: single
  sequence:
    # Disparar o alarme
    - service: alarm_control_panel.alarm_trigger
      target:
        entity_id: alarm_control_panel.alarmo

    # Ativar sirenes no mÃ¡ximo
    - service: siren.turn_on
      target:
        entity_id:
          - siren.sirene_interna
          - siren.sirene_externa
      data:
        duration: 600
        volume_level: 1.0

    # Acender todas as luzes
    - service: light.turn_on
      target:
        entity_id: all
      data:
        brightness: 255

    # Snapshot de todas as cÃ¢meras
    - service: camera.snapshot
      target:
        entity_id: camera.cam_entrada
      data:
        filename: /config/www/snapshots/panic_entrada_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg
    - service: camera.snapshot
      target:
        entity_id: camera.cam_fundos
      data:
        filename: /config/www/snapshots/panic_fundos_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg

    # NotificaÃ§Ã£o de emergÃªncia
    - service: notify.notify
      data:
        title: "ðŸ†˜ PÃ‚NICO ATIVADO!"
        message: >
          BotÃ£o de pÃ¢nico pressionado Ã s {{ now().strftime('%H:%M:%S') }}.
          Todas as sirenes e luzes ativadas.
          Verifique as cÃ¢meras imediatamente.
        data:
          push:
            sound:
              name: alarm
              critical: 1
              volume: 1.0

# ---------------------------------------------------------------------------
# Reset completo do alarme
# Desativa sirenes, restaura luzes, desarma alarme.
# ---------------------------------------------------------------------------
alarm_reset:
  alias: "ðŸ”„ Reset do Alarme"
  description: "Desativa sirenes, restaura luzes e desarma o alarme"
  icon: mdi:shield-refresh
  mode: single
  sequence:
    # Desarmar alarme
    - service: alarm_control_panel.alarm_disarm
      target:
        entity_id: alarm_control_panel.alarmo

    # Desativar sirenes
    - service: siren.turn_off
      target:
        entity_id:
          - siren.sirene_interna
          - siren.sirene_externa

    # Restaurar luzes
    - service: light.turn_off
      target:
        entity_id: light.luzes_externas

    # NotificaÃ§Ã£o
    - service: notify.notify
      data:
        title: "âœ… Alarme resetado"
        message: "Alarme desarmado e sirenes desativadas Ã s {{ now().strftime('%H:%M:%S') }}."

# ---------------------------------------------------------------------------
# Teste do sistema (sirene curta + verificaÃ§Ã£o)
# ---------------------------------------------------------------------------
system_test:
  alias: "ðŸ§ª Teste do Sistema"
  description: "Testa sirene (2 seg), cÃ¢meras e sensores"
  icon: mdi:test-tube
  mode: single
  sequence:
    # Teste de sirene (2 segundos)
    - service: siren.turn_on
      target:
        entity_id: siren.sirene_interna
      data:
        duration: 2
        volume_level: 0.3

    - delay:
        seconds: 3

    # Snapshot de teste de todas as cÃ¢meras
    - service: camera.snapshot
      target:
        entity_id:
          - camera.cam_entrada
          - camera.cam_fundos
          - camera.cam_lateral
          - camera.cam_garagem
      data:
        filename: /config/www/snapshots/test_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg

    # NotificaÃ§Ã£o de resultado
    - service: notify.notify
      data:
        title: "ðŸ§ª Teste do sistema concluÃ­do"
        message: >
          Teste realizado Ã s {{ now().strftime('%H:%M:%S') }}.
          Sirene: OK
          CÃ¢meras: Verifique os snapshots.
          Sensores: {{ states.binary_sensor | selectattr('attributes.device_class', 'defined')
            | selectattr('attributes.device_class', 'in', ['door', 'window', 'motion'])
            | list | count }} ativos.
