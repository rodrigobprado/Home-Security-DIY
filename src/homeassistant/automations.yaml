# =============================================================================
# Home Assistant - AutomaÃ§Ãµes de SeguranÃ§a
# Home Security DIY
# =============================================================================
# ReferÃªncia: https://www.home-assistant.io/docs/automation/

# =============================================================================
# ALARME - NOTIFICAÃ‡Ã•ES
# =============================================================================

# ---------------------------------------------------------------------------
# NotificaÃ§Ã£o ao disparar o alarme
# Envia push notification com snapshot da cÃ¢mera quando o alarme dispara.
# PRD: RF-029, RF-035 (PRD_SENSORS_AND_ALARMS_PLATFORM)
# ---------------------------------------------------------------------------
- id: alarm_triggered_notification
  alias: "SeguranÃ§a - Alarme disparado - NotificaÃ§Ã£o"
  description: "Envia notificaÃ§Ã£o push e Telegram quando o alarme dispara"
  trigger:
    - platform: state
      entity_id: alarm_control_panel.alarmo
      to: "triggered"
  condition:
    - condition: state
      entity_id: input_boolean.alarm_notifications
      state: "on"
  action:
    # Snapshot da cÃ¢mera de entrada
    - service: camera.snapshot
      target:
        entity_id: camera.cam_entrada
      data:
        filename: /config/www/snapshots/alarm_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg

    # NotificaÃ§Ã£o push (Home Assistant Companion App)
    - service: notify.notify
      data:
        title: "ðŸš¨ ALARME DISPARADO!"
        message: >
          Alarme disparado Ã s {{ now().strftime('%H:%M:%S') }}.
          Sensor: {{ trigger.to_state.attributes.open_sensors | default('desconhecido') }}
        data:
          push:
            sound:
              name: alarm
              critical: 1
              volume: 1.0
          image: /local/snapshots/alarm_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg
          actions:
            - action: ALARM_DISARM
              title: "Desarmar"
            - action: ALARM_VIEW_CAMERAS
              title: "Ver cÃ¢meras"

    # NotificaÃ§Ã£o Telegram (canal redundante)
    # Descomente e configure o bot_token/chat_id no HA
    # - service: notify.telegram
    #   data:
    #     title: "ðŸš¨ ALARME DISPARADO!"
    #     message: >
    #       Alarme disparado Ã s {{ now().strftime('%H:%M:%S') }}.
    #       Sensor: {{ trigger.to_state.attributes.open_sensors | default('desconhecido') }}

# ---------------------------------------------------------------------------
# NotificaÃ§Ã£o ao armar/desarmar
# PRD: RF-029 (PRD_SENSORS_AND_ALARMS_PLATFORM)
# ---------------------------------------------------------------------------
- id: alarm_state_change_notification
  alias: "SeguranÃ§a - MudanÃ§a de estado do alarme"
  description: "Notifica quando o alarme Ã© armado ou desarmado"
  trigger:
    - platform: state
      entity_id: alarm_control_panel.alarmo
      to:
        - "armed_away"
        - "armed_night"
        - "armed_home"
        - "disarmed"
  condition:
    - condition: state
      entity_id: input_select.alarm_notification_level
      state: "Todos os eventos"
  action:
    - service: notify.notify
      data:
        title: "ðŸ” Estado do alarme alterado"
        message: >
          {% set states_map = {
            'armed_away': 'ðŸŸ¢ Armado Total',
            'armed_night': 'ðŸŸ¡ Armado Noite',
            'armed_home': 'ðŸ”µ Armado PerÃ­metro',
            'disarmed': 'âšª Desarmado'
          } %}
          {{ states_map[trigger.to_state.state] }}
          Ã s {{ now().strftime('%H:%M:%S') }}

# =============================================================================
# ALARME - RESPOSTA AUTOMÃTICA
# =============================================================================

# ---------------------------------------------------------------------------
# Ativar sirene e iluminaÃ§Ã£o reativa ao disparar alarme
# PRD: RF-024, RF-025, RF-026 (PRD_SENSORS_AND_ALARMS_PLATFORM)
# ---------------------------------------------------------------------------
- id: alarm_triggered_response
  alias: "SeguranÃ§a - Alarme disparado - Resposta"
  description: "Ativa sirene e luzes ao disparar alarme"
  trigger:
    - platform: state
      entity_id: alarm_control_panel.alarmo
      to: "triggered"
  action:
    # Ativar sirene interna (Zigbee)
    - service: siren.turn_on
      target:
        entity_id: siren.sirene_interna
      data:
        duration: 300 # 5 minutos
        volume_level: 1.0

    # Ativar sirene externa (se existir)
    - service: siren.turn_on
      target:
        entity_id: siren.sirene_externa
      data:
        duration: 300

    # Acender todas as luzes externas (dissuasÃ£o)
    - service: light.turn_on
      target:
        entity_id: light.luzes_externas
      data:
        brightness: 255

    # Acender luzes internas
    - service: light.turn_on
      target:
        entity_id: light.luzes_internas
      data:
        brightness: 255

# ---------------------------------------------------------------------------
# Desativar resposta ao desarmar alarme
# ---------------------------------------------------------------------------
- id: alarm_disarmed_response
  alias: "SeguranÃ§a - Alarme desarmado - Parar resposta"
  description: "Desativa sirenes e restaura luzes ao desarmar"
  trigger:
    - platform: state
      entity_id: alarm_control_panel.alarmo
      to: "disarmed"
  action:
    - service: siren.turn_off
      target:
        entity_id:
          - siren.sirene_interna
          - siren.sirene_externa

# =============================================================================
# DETECÃ‡ÃƒO DE INTRUSÃƒO (FRIGATE + ALARME)
# =============================================================================

# ---------------------------------------------------------------------------
# Pessoa detectada enquanto alarme armado â†’ disparo do alarme
# PRD: RF-036, RF-037 (PRD_SENSORS_AND_ALARMS_PLATFORM)
# ---------------------------------------------------------------------------
- id: frigate_person_detected_alarm
  alias: "SeguranÃ§a - Pessoa detectada com alarme armado"
  description: "Dispara alarme quando Frigate detecta pessoa e alarme estÃ¡ armado"
  trigger:
    - platform: mqtt
      topic: frigate/events
  condition:
    - condition: template
      value_template: "{{ trigger.payload_json['after']['label'] == 'person' }}"
    - condition: template
      value_template: "{{ trigger.payload_json['type'] == 'new' }}"
    - condition: state
      entity_id: alarm_control_panel.alarmo
      state:
        - "armed_away"
        - "armed_night"
        - "armed_home"
  action:
    - service: alarm_control_panel.alarm_trigger
      target:
        entity_id: alarm_control_panel.alarmo

# ---------------------------------------------------------------------------
# NotificaÃ§Ã£o de pessoa detectada (alarme desarmado)
# PRD: RF-019 (PRD_VIDEO_SURVEILLANCE_AND_NVR)
# ---------------------------------------------------------------------------
- id: frigate_person_detected_info
  alias: "SeguranÃ§a - Pessoa detectada - Info"
  description: "Notifica detecÃ§Ã£o de pessoa mesmo com alarme desarmado"
  trigger:
    - platform: mqtt
      topic: frigate/events
  condition:
    - condition: template
      value_template: "{{ trigger.payload_json['after']['label'] == 'person' }}"
    - condition: template
      value_template: "{{ trigger.payload_json['type'] == 'new' }}"
    - condition: state
      entity_id: alarm_control_panel.alarmo
      state: "disarmed"
    - condition: state
      entity_id: input_select.alarm_notification_level
      state: "Todos os eventos"
  action:
    - service: notify.notify
      data:
        title: "ðŸ‘¤ Pessoa detectada"
        message: >
          Pessoa detectada na cÃ¢mera {{ trigger.payload_json['after']['camera'] }}
          Ã s {{ now().strftime('%H:%M:%S') }}.
        data:
          image: >
            /api/frigate/notifications/{{ trigger.payload_json['after']['id'] }}/snapshot.jpg

# =============================================================================
# MONITORAMENTO DE SAÃšDE DO SISTEMA
# =============================================================================

# ---------------------------------------------------------------------------
# Alerta de bateria baixa em sensores Zigbee
# PRD: RNF-011 (PRD_SENSORS_AND_ALARMS_PLATFORM)
# ---------------------------------------------------------------------------
- id: sensor_battery_low
  alias: "Sistema - Bateria baixa de sensor"
  description: "Notifica quando bateria de sensor Zigbee cai abaixo de 20%"
  trigger:
    - platform: numeric_state
      entity_id:
        - sensor.porta_frente_battery
        - sensor.porta_fundos_battery
        - sensor.porta_quintal_battery
        - sensor.janela_sala_battery
        - sensor.janela_quarto_battery
        - sensor.pir_sala_battery
        - sensor.pir_corredor_battery
      below: 20
  action:
    - service: notify.notify
      data:
        title: "âš ï¸ BATERIA FRACA!"
        message: "O dispositivo {{ trigger.to_state.name }} estÃ¡ com bateria abaixo de 20%."

# ---------------------------------------------------------------------------
# Alerta de cÃ¢mera offline
# PRD: RF-005 (PRD_MONITORING_DASHBOARD)
# ---------------------------------------------------------------------------
- id: camera_offline_alert
  alias: "Sistema - CÃ¢mera offline"
  description: "Notifica quando uma cÃ¢mera fica indisponÃ­vel por mais de 5 minutos"
  trigger:
    - platform: state
      entity_id:
        - camera.cam_entrada
        - camera.cam_fundos
        - camera.cam_lateral
        - camera.cam_garagem
      to: "unavailable"
      for:
        minutes: 5
  action:
    - service: notify.notify
      data:
        title: "ðŸ“¹ CÃ¢mera offline!"
        message: >
          A cÃ¢mera {{ trigger.to_state.attributes.friendly_name | default(trigger.entity_id) }}
          estÃ¡ offline hÃ¡ mais de 5 minutos.
          Verifique a conexÃ£o de rede e alimentaÃ§Ã£o.

# =============================================================================
# AUTO-ARMAR
# =============================================================================

# ---------------------------------------------------------------------------
# Auto-armar alarme Ã  noite (modo noite)
# PRD: RF-023 (PRD_SENSORS_AND_ALARMS_PLATFORM)
# ---------------------------------------------------------------------------
- id: alarm_auto_arm_night
  alias: "SeguranÃ§a - Auto-armar Ã  noite"
  description: "Arma o alarme automaticamente no horÃ¡rio configurado"
  trigger:
    - platform: time
      at: input_datetime.alarm_auto_arm_time
  condition:
    - condition: state
      entity_id: input_boolean.alarm_auto_arm
      state: "on"
    - condition: state
      entity_id: alarm_control_panel.alarmo
      state: "disarmed"
  action:
    - service: alarm_control_panel.alarm_arm_night
      target:
        entity_id: alarm_control_panel.alarmo

    - service: notify.notify
      data:
        title: "ðŸŒ™ Alarme armado automaticamente"
        message: "Modo noturno ativado Ã s {{ now().strftime('%H:%M') }}."

# =============================================================================
# AÃ‡Ã•ES DE NOTIFICAÃ‡ÃƒO (resposta a aÃ§Ãµes nos push notifications)
# =============================================================================

# ---------------------------------------------------------------------------
# Desarmar via notificaÃ§Ã£o push
# ---------------------------------------------------------------------------
- id: alarm_disarm_from_notification
  alias: "SeguranÃ§a - Desarmar via notificaÃ§Ã£o"
  description: "Permite desarmar o alarme pela aÃ§Ã£o na notificaÃ§Ã£o push"
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: ALARM_DISARM
  action:
    - service: alarm_control_panel.alarm_disarm
      target:
        entity_id: alarm_control_panel.alarmo

# ---------------------------------------------------------------------------
# DetecÃ§Ã£o de Potencial Jamming / Falha CrÃ­tica Zigbee
# PRD: T-052 (TASKS_BACKLOG)
# ---------------------------------------------------------------------------
- id: security_zigbee_integrity
  alias: "SeguranÃ§a - Monitor de Integridade Zigbee (Bridge Offline)"
  description: "Detecta se o coordenador Zigbee ficou offline ou desconectado"
  trigger:
    - platform: state
      entity_id: sensor.zigbee2mqtt_bridge_state
      to: "offline"
      for:
        seconds: 30
    - platform: state
      entity_id: binary_sensor.zigbee2mqtt_connection_state
      to: "off"
      for:
        seconds: 30
  action:
    - service: notify.notify
      data:
        title: "ðŸš¨ FALHA CRÃTICA / JAMMING ZIGBEE"
        message: >
          O sistema Zigbee parou de responder.
          PossÃ­vel interferÃªncia (Jamming), desconexÃ£o do USB ou falha do servico.
          Verifique o servidor IMEDIATAMENTE.
        data:
          push:
            sound:
              name: default
              critical: 1
              volume: 1.0
    - service: persistent_notification.create
      data:
        title: "ðŸš¨ FALHA ZIGBEE"
        message: "Coordenador Zigbee offline. Sensores inoperantes."

# ---------------------------------------------------------------------------
# DetecÃ§Ã£o AvanÃ§ada de Jamming (Queda SimultÃ¢nea de Sensores)
# PRD: T-052 (TASKS_BACKLOG)
# ---------------------------------------------------------------------------
- id: security_zigbee_mass_failure
  alias: "SeguranÃ§a - DetecÃ§Ã£o de Jamming RF (Queda Massiva)"
  description: "Detecta se mÃºltiplos sensores Zigbee ficam indisponÃ­veis ao mesmo tempo, indicando Jamming de RF."
  trigger:
    - platform: time_pattern
      minutes: "/1" # Checa a cada minuto
  condition:
    - condition: template
      value_template: >
        {% set sensors = [
          'sensor.porta_frente_battery',
          'sensor.porta_fundos_battery',
          'sensor.janela_sala_battery',
          'sensor.janela_quarto_battery',
          'sensor.pir_sala_battery',
          'sensor.pir_corredor_battery'
        ] %}
        {{ states | selectattr('entity_id', 'in', sensors) | selectattr('state', 'in', ['unavailable', 'unknown']) | list | count >= 3 }}
  action:
    - service: notify.notify
      data:
        title: "ðŸš¨ ALERTA DE JAMMING DETECTADO"
        message: >
          MÃºltiplos sensores (3+) perderam conexÃ£o simultaneamente.
          Isso indica forte interferÃªncia ou ataque de Jamming.
          O sistema pode estar comprometido.
        data:
          push:
            sound:
              name: default
              critical: 1
              volume: 1.0

    # Opcional: Ativar sirene preventiva ou luzes
    - service: light.turn_on
      target:
        entity_id: light.luzes_externas
      data:
        brightness: 255
        rgb_color: [255, 0, 0] # Vermelho
