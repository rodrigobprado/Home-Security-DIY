# =============================================================================
# Home Assistant - Automa√ß√µes de Seguran√ßa
# Home Security DIY
# =============================================================================
# Refer√™ncia: https://www.home-assistant.io/docs/automation/

# =============================================================================
# ALARME - NOTIFICA√á√ïES
# =============================================================================

# ---------------------------------------------------------------------------
# Notifica√ß√£o ao disparar o alarme
# Envia push notification com snapshot da c√¢mera quando o alarme dispara.
# PRD: RF-029, RF-035 (PRD_SENSORS_AND_ALARMS_PLATFORM)
# ---------------------------------------------------------------------------
- id: alarm_triggered_notification
  alias: "Seguran√ßa - Alarme disparado - Notifica√ß√£o"
  description: "Envia notifica√ß√£o push e Telegram quando o alarme dispara"
  trigger:
    - platform: state
      entity_id: alarm_control_panel.alarmo
      to: "triggered"
  condition:
    - condition: state
      entity_id: input_boolean.alarm_notifications
      state: "on"
  action:
    # Snapshot da c√¢mera de entrada
    - service: camera.snapshot
      target:
        entity_id: camera.cam_entrada
      data:
        filename: /config/www/snapshots/alarm_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg

    # Notifica√ß√£o push (Home Assistant Companion App)
    - service: notify.notify
      data:
        title: "üö® ALARME DISPARADO!"
        message: >
          Alarme disparado √†s {{ now().strftime('%H:%M:%S') }}.
          Sensor: {{ trigger.to_state.attributes.open_sensors | default('desconhecido') }}
        data:
          push:
            sound:
              name: alarm
              critical: 1
              volume: 1.0
          image: /local/snapshots/alarm_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg
          actions:
            - action: ALARM_DISARM
              title: "Desarmar"
            - action: ALARM_VIEW_CAMERAS
              title: "Ver c√¢meras"

    # Notifica√ß√£o Telegram (canal redundante)
    # Descomente e configure o bot_token/chat_id no HA
    # - service: notify.telegram
    #   data:
    #     title: "üö® ALARME DISPARADO!"
    #     message: >
    #       Alarme disparado √†s {{ now().strftime('%H:%M:%S') }}.
    #       Sensor: {{ trigger.to_state.attributes.open_sensors | default('desconhecido') }}

# ---------------------------------------------------------------------------
# Notifica√ß√£o ao armar/desarmar
# PRD: RF-029 (PRD_SENSORS_AND_ALARMS_PLATFORM)
# ---------------------------------------------------------------------------
- id: alarm_state_change_notification
  alias: "Seguran√ßa - Mudan√ßa de estado do alarme"
  description: "Notifica quando o alarme √© armado ou desarmado"
  trigger:
    - platform: state
      entity_id: alarm_control_panel.alarmo
      to:
        - "armed_away"
        - "armed_night"
        - "armed_home"
        - "disarmed"
  condition:
    - condition: state
      entity_id: input_select.alarm_notification_level
      state: "Todos os eventos"
  action:
    - service: notify.notify
      data:
        title: "üîê Estado do alarme alterado"
        message: >
          {% set states_map = {
            'armed_away': 'üü¢ Armado Total',
            'armed_night': 'üü° Armado Noite',
            'armed_home': 'üîµ Armado Per√≠metro',
            'disarmed': '‚ö™ Desarmado'
          } %}
          {{ states_map[trigger.to_state.state] }}
          √†s {{ now().strftime('%H:%M:%S') }}

# =============================================================================
# ALARME - RESPOSTA AUTOM√ÅTICA
# =============================================================================

# ---------------------------------------------------------------------------
# Ativar sirene e ilumina√ß√£o reativa ao disparar alarme
# PRD: RF-024, RF-025, RF-026 (PRD_SENSORS_AND_ALARMS_PLATFORM)
# ---------------------------------------------------------------------------
- id: alarm_triggered_response
  alias: "Seguran√ßa - Alarme disparado - Resposta"
  description: "Ativa sirene e luzes ao disparar alarme"
  trigger:
    - platform: state
      entity_id: alarm_control_panel.alarmo
      to: "triggered"
  action:
    # Ativar sirene interna (Zigbee)
    - service: siren.turn_on
      target:
        entity_id: siren.sirene_interna
      data:
        duration: 300 # 5 minutos
        volume_level: 1.0

    # Ativar sirene externa (se existir)
    - service: siren.turn_on
      target:
        entity_id: siren.sirene_externa
      data:
        duration: 300

    # Acender todas as luzes externas (dissuas√£o)
    - service: light.turn_on
      target:
        entity_id: light.luzes_externas
      data:
        brightness: 255

    # Acender luzes internas
    - service: light.turn_on
      target:
        entity_id: light.luzes_internas
      data:
        brightness: 255

# ---------------------------------------------------------------------------
# Desativar resposta ao desarmar alarme
# ---------------------------------------------------------------------------
- id: alarm_disarmed_response
  alias: "Seguran√ßa - Alarme desarmado - Parar resposta"
  description: "Desativa sirenes e restaura luzes ao desarmar"
  trigger:
    - platform: state
      entity_id: alarm_control_panel.alarmo
      to: "disarmed"
  action:
    - service: siren.turn_off
      target:
        entity_id:
          - siren.sirene_interna
          - siren.sirene_externa

# =============================================================================
# DETEC√á√ÉO DE INTRUS√ÉO (FRIGATE + ALARME)
# =============================================================================

# ---------------------------------------------------------------------------
# Pessoa detectada enquanto alarme armado ‚Üí disparo do alarme
# PRD: RF-036, RF-037 (PRD_SENSORS_AND_ALARMS_PLATFORM)
# ---------------------------------------------------------------------------
- id: frigate_person_detected_alarm
  alias: "Seguran√ßa - Pessoa detectada com alarme armado"
  description: "Dispara alarme quando Frigate detecta pessoa e alarme est√° armado"
  trigger:
    - platform: mqtt
      topic: frigate/events
  condition:
    - condition: template
      value_template: "{{ trigger.payload_json['after']['label'] == 'person' }}"
    - condition: template
      value_template: "{{ trigger.payload_json['type'] == 'new' }}"
    - condition: state
      entity_id: alarm_control_panel.alarmo
      state:
        - "armed_away"
        - "armed_night"
        - "armed_home"
  action:
    - service: alarm_control_panel.alarm_trigger
      target:
        entity_id: alarm_control_panel.alarmo

# ---------------------------------------------------------------------------
# Notifica√ß√£o de pessoa detectada (alarme desarmado)
# PRD: RF-019 (PRD_VIDEO_SURVEILLANCE_AND_NVR)
# ---------------------------------------------------------------------------
- id: frigate_person_detected_info
  alias: "Seguran√ßa - Pessoa detectada - Info"
  description: "Notifica detec√ß√£o de pessoa mesmo com alarme desarmado"
  trigger:
    - platform: mqtt
      topic: frigate/events
  condition:
    - condition: template
      value_template: "{{ trigger.payload_json['after']['label'] == 'person' }}"
    - condition: template
      value_template: "{{ trigger.payload_json['type'] == 'new' }}"
    - condition: state
      entity_id: alarm_control_panel.alarmo
      state: "disarmed"
    - condition: state
      entity_id: input_select.alarm_notification_level
      state: "Todos os eventos"
  action:
    - service: notify.notify
      data:
        title: "üë§ Pessoa detectada"
        message: >
          Pessoa detectada na c√¢mera {{ trigger.payload_json['after']['camera'] }}
          √†s {{ now().strftime('%H:%M:%S') }}.
        data:
          image: >
            /api/frigate/notifications/{{ trigger.payload_json['after']['id'] }}/snapshot.jpg

# =============================================================================
# MONITORAMENTO DE SA√öDE DO SISTEMA
# =============================================================================

# ---------------------------------------------------------------------------
# Alerta de bateria baixa em sensores Zigbee
# PRD: RNF-011 (PRD_SENSORS_AND_ALARMS_PLATFORM)
# ---------------------------------------------------------------------------
- id: sensor_battery_low
  alias: "Sistema - Bateria baixa de sensor"
  description: "Notifica quando bateria de sensor Zigbee cai abaixo de 20%"
  trigger:
    - platform: numeric_state
      entity_id:
        - sensor.porta_frente_battery
        - sensor.porta_fundos_battery
        - sensor.porta_quintal_battery
        - sensor.janela_sala_battery
        - sensor.janela_quarto_battery
        - sensor.pir_sala_battery
        - sensor.pir_corredor_battery
      below: 20
  action:
    - service: notify.notify
      data:
        title: "‚ö†Ô∏è Bateria baixa"
        message: >
          O sensor {{ trigger.to_state.attributes.friendly_name | default(trigger.entity_id) }}
          est√° com {{ trigger.to_state.state }}% de bateria.
          Troque a bateria em breve.

# ---------------------------------------------------------------------------
# Alerta de c√¢mera offline
# PRD: RF-005 (PRD_MONITORING_DASHBOARD)
# ---------------------------------------------------------------------------
- id: camera_offline_alert
  alias: "Sistema - C√¢mera offline"
  description: "Notifica quando uma c√¢mera fica indispon√≠vel por mais de 5 minutos"
  trigger:
    - platform: state
      entity_id:
        - camera.cam_entrada
        - camera.cam_fundos
        - camera.cam_lateral
        - camera.cam_garagem
      to: "unavailable"
      for:
        minutes: 5
  action:
    - service: notify.notify
      data:
        title: "üìπ C√¢mera offline!"
        message: >
          A c√¢mera {{ trigger.to_state.attributes.friendly_name | default(trigger.entity_id) }}
          est√° offline h√° mais de 5 minutos.
          Verifique a conex√£o de rede e alimenta√ß√£o.

# =============================================================================
# AUTO-ARMAR
# =============================================================================

# ---------------------------------------------------------------------------
# Auto-armar alarme √† noite (modo noite)
# PRD: RF-023 (PRD_SENSORS_AND_ALARMS_PLATFORM)
# ---------------------------------------------------------------------------
- id: alarm_auto_arm_night
  alias: "Seguran√ßa - Auto-armar √† noite"
  description: "Arma o alarme automaticamente no hor√°rio configurado"
  trigger:
    - platform: time
      at: input_datetime.alarm_auto_arm_time
  condition:
    - condition: state
      entity_id: input_boolean.alarm_auto_arm
      state: "on"
    - condition: state
      entity_id: alarm_control_panel.alarmo
      state: "disarmed"
  action:
    - service: alarm_control_panel.alarm_arm_night
      target:
        entity_id: alarm_control_panel.alarmo

    - service: notify.notify
      data:
        title: "üåô Alarme armado automaticamente"
        message: "Modo noturno ativado √†s {{ now().strftime('%H:%M') }}."

# =============================================================================
# A√á√ïES DE NOTIFICA√á√ÉO (resposta a a√ß√µes nos push notifications)
# =============================================================================

# ---------------------------------------------------------------------------
# Desarmar via notifica√ß√£o push
# ---------------------------------------------------------------------------
- id: alarm_disarm_from_notification
  alias: "Seguran√ßa - Desarmar via notifica√ß√£o"
  description: "Permite desarmar o alarme pela a√ß√£o na notifica√ß√£o push"
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: ALARM_DISARM
  action:
    - service: alarm_control_panel.alarm_disarm
      target:
        entity_id: alarm_control_panel.alarmo
