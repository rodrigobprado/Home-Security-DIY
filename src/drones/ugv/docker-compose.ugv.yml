version: "3.8"

services:
  # ---------------------------------------------------------------------------
  # UGV Brain (ROS 2 Humble)
  # ---------------------------------------------------------------------------
  ugv-brain:
    build:
      context: .
      dockerfile: Dockerfile
    image: home-security-ugv-brain:latest
    container_name: ugv-brain
    restart: unless-stopped
    command: python3 /app/ugv_control.py
    volumes:
      - ./app:/app
      - ../common:/app/common
      - ./ros2:/app/ros2
      - ./scripts:/app/scripts
    devices:
      - /dev/ttyUSB0:/dev/ttyUSB0 # ESP32
      - /dev/video0:/dev/video0 # Camera
    networks:
      - ugv-net
    environment:
      - ROS_DOMAIN_ID=0
      - MQTT_BROKER=192.168.1.100 # Replace with actual broker IP
      - MQTT_PORT=1883
      - MQTT_USER=homeassistant
      - MQTT_PASSWORD=CHANGE_ME
      - DEFENSE_PIN_UGV=CHANGE_ME_ugv_pin
      - DEFENSE_TOTP_SECRET_UGV=JBSWY3DPEHPK3PXP
      - DEFENSE_WARNING_SECONDS_UGV=5
      - DEFENSE_COOLDOWN_SECONDS_UGV=30
      - DEFENSE_MAX_TRIGGERS_PER_DAY_UGV=3
      - DEFENSE_EXCLUSION_ZONES_UGV=sidewalk,service_entry,neighbor_gate
      - DEFENSE_AUDIT_LOG_PATH_UGV=/tmp/ugv_defense_audit.log
      - DEFENSE_ACTUATOR_SPEC_UGV=solenoid_12v_nc+co2_valve
      - COMMAND_HMAC_SECRET_UGV=CHANGE_ME_ugv_hmac_secret
      - COMMAND_ALLOWED_SOURCES_UGV=dashboard,homeassistant
      - COMMAND_MAX_SKEW_SECONDS_UGV=30
      - ALLOW_UNSIGNED_HOMEASSISTANT_COMMANDS_UGV=false
      - RTSP_URI=rtsp://mediamtx:8554/cam
      - ROS2_ENABLED=true
      - ROS2_PATROL_TOPIC=/ugv/patrol/goal
      - ROS2_PATROL_ROUTE_FILE=/app/ros2/routes/patrol_routes.json
      - WIFI_RSSI_THRESHOLD_UGV=-78
      - FAILOVER_TIMEOUT_SECONDS_UGV=30
    depends_on:
      - ugv-ros2-nav

  # ---------------------------------------------------------------------------
  # RTSP Server (MediaMTX) - Low Latency Streaming
  # ---------------------------------------------------------------------------
  mediamtx:
    image: bluenviron/mediamtx:1.11.3
    container_name: ugv-mediamtx
    restart: unless-stopped
    networks:
      - ugv-net
    ports:
      - "127.0.0.1:8554:8554"
    environment:
      - MTX_PROTOCOLS=tcp
      - MTX_WEBRTC=no # Disable WebRTC to save resources if not needed

  # ---------------------------------------------------------------------------
  # ROS2 Nav Stack (Nav2 + SLAM)
  # ---------------------------------------------------------------------------
  ugv-ros2-nav:
    build:
      context: .
      dockerfile: Dockerfile
    image: home-security-ugv-brain:latest
    container_name: ugv-ros2-nav
    restart: unless-stopped
    command: /app/scripts/start_nav_stack.sh
    volumes:
      - ./ros2:/app/ros2
      - ./scripts:/app/scripts
    networks:
      - ugv-net
    environment:
      - ROS_DOMAIN_ID=0

  # ---------------------------------------------------------------------------
  # Simulation Smoke Test (Gazebo/Nav2 package availability)
  # ---------------------------------------------------------------------------
  ugv-gazebo-smoke:
    build:
      context: .
      dockerfile: Dockerfile
    image: home-security-ugv-brain:latest
    container_name: ugv-gazebo-smoke
    profiles: ["test"]
    command: /app/scripts/run_gazebo_smoke_test.sh
    volumes:
      - ./scripts:/app/scripts
    networks:
      - ugv-net

networks:
  ugv-net:
    driver: bridge
