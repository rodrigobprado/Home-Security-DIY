# =============================================================================
# Mosquitto MQTT Broker Configuration
# Home Security DIY
# =============================================================================
# Referência: https://mosquitto.org/man/mosquitto-conf-5.html

# --- Listener ---
listener 1883
protocol mqtt

# WebSocket listener (for browser-based clients)
listener 9001
protocol websockets

# --- Authentication ---
# To create the password file:
#   docker exec home-security-mosquitto mosquitto_passwd -c /mosquitto/config/password_file homeassistant
#   docker exec home-security-mosquitto mosquitto_passwd -b /mosquitto/config/password_file zigbee2mqtt <password>
#   docker exec home-security-mosquitto mosquitto_passwd -b /mosquitto/config/password_file frigate <password>
allow_anonymous false
password_file /mosquitto/config/password_file
acl_file /mosquitto/config/acl_file

# --- Persistence ---
persistence true
persistence_location /mosquitto/data/

# --- Logging ---
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout
log_type error
log_type warning
log_type notice
log_type information
log_timestamp true
log_timestamp_format %Y-%m-%dT%H:%M:%S

# --- TLS (optional but recommended for external access) ---
# Production baseline disponível em:
#   /mosquitto/config/mosquitto.prod.conf
# (TLS-only em 8883, sem listener plaintext 1883)
# Uncomment and configure after running scripts/generate-mqtt-certs.sh
# To enable TLS, replace the plain listener 1883 above with the block below:
#
# listener 8883
# protocol mqtt
# cafile /mosquitto/certs/ca.crt
# certfile /mosquitto/certs/server.crt
# keyfile /mosquitto/certs/server.key
# tls_version tlsv1.2
# require_certificate false
#
# Keep listener 1883 only for internal Docker network (loopback/compose network).
# Expose only 8883 if external MQTT access is needed.

# --- Security ---
# Max inflight messages per client
max_inflight_messages 20

# Max queued messages per client
max_queued_messages 1000

# Max packet size (256KB - sufficient for snapshots)
message_size_limit 262144

# Connection timeout
connection_messages true
