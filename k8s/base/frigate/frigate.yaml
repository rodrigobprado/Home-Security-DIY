# =============================================================================
# Frigate NVR - Kubernetes Manifests
# Home Security DIY
# =============================================================================

# --- ConfigMap ---
apiVersion: v1
kind: ConfigMap
metadata:
  name: frigate-config
  namespace: home-security
  labels:
    app.kubernetes.io/name: frigate
    app.kubernetes.io/component: nvr
    app.kubernetes.io/part-of: home-security
data:
  config.yml: |
    mqtt:
      enabled: true
      host: mosquitto
      port: 1883
      user: '{FRIGATE_MQTT_USER}'
      password: '{FRIGATE_MQTT_PASSWORD}'
      topic_prefix: frigate

    detectors:
      openvino:
        type: openvino
        device: AUTO
        model:
          path: /openvino-model/ssdlite_mobilenet_v2.xml

    model:
      width: 300
      height: 300
      input_tensor: nhwc
      input_pixel_format: bgr
      labelmap_path: /openvino-model/coco_91cl_bkgr.txt

    objects:
      track:
        - person
        - car
        - motorcycle
        - bicycle
        - dog
        - cat
      filters:
        person:
          min_area: 5000
          max_area: 100000
          min_score: 0.5
          threshold: 0.7
        car:
          min_area: 10000
          min_score: 0.5
          threshold: 0.7

    record:
      enabled: true
      retain:
        days: 30
        mode: motion
      events:
        pre_capture: 5
        post_capture: 10
        retain:
          default: 60
          mode: active_objects
          objects:
            person: 90
            car: 60

    snapshots:
      enabled: true
      clean_copy: true
      timestamp: true
      bounding_box: true
      retain:
        default: 90
        objects:
          person: 90
          car: 60

    go2rtc:
      streams:
        cam_entrada:
          - '{FRIGATE_CAM_ENTRADA_URL}'
        cam_entrada_sub:
          - '{FRIGATE_CAM_ENTRADA_SUB_URL}'
        cam_fundos:
          - '{FRIGATE_CAM_FUNDOS_URL}'
        cam_fundos_sub:
          - '{FRIGATE_CAM_FUNDOS_SUB_URL}'
        cam_lateral:
          - '{FRIGATE_CAM_LATERAL_URL}'
        cam_lateral_sub:
          - '{FRIGATE_CAM_LATERAL_SUB_URL}'
        cam_garagem:
          - '{FRIGATE_CAM_GARAGEM_URL}'
        cam_garagem_sub:
          - '{FRIGATE_CAM_GARAGEM_SUB_URL}'

    cameras:
      cam_entrada:
        enabled: true
        ffmpeg:
          inputs:
            - path: rtsp://127.0.0.1:8554/cam_entrada
              input_args: preset-rtsp-restream
              roles: [record]
            - path: rtsp://127.0.0.1:8554/cam_entrada_sub
              input_args: preset-rtsp-restream
              roles: [detect]
        detect:
          enabled: true
          width: 1280
          height: 720
          fps: 10
        objects:
          track: [person, car, motorcycle, bicycle]
        snapshots:
          enabled: true
        record:
          enabled: true

      cam_fundos:
        enabled: true
        ffmpeg:
          inputs:
            - path: rtsp://127.0.0.1:8554/cam_fundos
              input_args: preset-rtsp-restream
              roles: [record]
            - path: rtsp://127.0.0.1:8554/cam_fundos_sub
              input_args: preset-rtsp-restream
              roles: [detect]
        detect:
          enabled: true
          width: 1280
          height: 720
          fps: 10
        objects:
          track: [person, dog, cat]
        snapshots:
          enabled: true
        record:
          enabled: true

      cam_lateral:
        enabled: true
        ffmpeg:
          inputs:
            - path: rtsp://127.0.0.1:8554/cam_lateral
              input_args: preset-rtsp-restream
              roles: [record]
            - path: rtsp://127.0.0.1:8554/cam_lateral_sub
              input_args: preset-rtsp-restream
              roles: [detect]
        detect:
          enabled: true
          width: 1280
          height: 720
          fps: 10
        objects:
          track: [person]
        snapshots:
          enabled: true
        record:
          enabled: true

      cam_garagem:
        enabled: true
        ffmpeg:
          inputs:
            - path: rtsp://127.0.0.1:8554/cam_garagem
              input_args: preset-rtsp-restream
              roles: [record]
            - path: rtsp://127.0.0.1:8554/cam_garagem_sub
              input_args: preset-rtsp-restream
              roles: [detect]
        detect:
          enabled: true
          width: 1280
          height: 720
          fps: 10
        objects:
          track: [person, car, motorcycle]
        snapshots:
          enabled: true
        record:
          enabled: true

---
# --- Secret (camera URLs - override in overlays) ---
apiVersion: v1
kind: Secret
metadata:
  name: frigate-cameras
  namespace: home-security
  labels:
    app.kubernetes.io/name: frigate
    app.kubernetes.io/part-of: home-security
type: Opaque
  # IMPORTANT: Never commit real credentials here.
  # Use scripts/generate-k8s-secrets.sh to create this Secret from your .env file,
  # or use SealedSecrets/External Secrets Operator for production deployments.
stringData:
  FRIGATE_CAM_ENTRADA_URL: "rtsp://CHANGE_ME_user:CHANGE_ME_password@CHANGE_ME_IP_1:554/h264Preview_01_main"
  FRIGATE_CAM_ENTRADA_SUB_URL: "rtsp://CHANGE_ME_user:CHANGE_ME_password@CHANGE_ME_IP_1:554/h264Preview_01_sub"
  FRIGATE_CAM_FUNDOS_URL: "rtsp://CHANGE_ME_user:CHANGE_ME_password@CHANGE_ME_IP_2:554/h264Preview_01_main"
  FRIGATE_CAM_FUNDOS_SUB_URL: "rtsp://CHANGE_ME_user:CHANGE_ME_password@CHANGE_ME_IP_2:554/h264Preview_01_sub"
  FRIGATE_CAM_LATERAL_URL: "rtsp://CHANGE_ME_user:CHANGE_ME_password@CHANGE_ME_IP_3:554/h264Preview_01_main"
  FRIGATE_CAM_LATERAL_SUB_URL: "rtsp://CHANGE_ME_user:CHANGE_ME_password@CHANGE_ME_IP_3:554/h264Preview_01_sub"
  FRIGATE_CAM_GARAGEM_URL: "rtsp://CHANGE_ME_user:CHANGE_ME_password@CHANGE_ME_IP_4:554/h264Preview_01_main"
  FRIGATE_CAM_GARAGEM_SUB_URL: "rtsp://CHANGE_ME_user:CHANGE_ME_password@CHANGE_ME_IP_4:554/h264Preview_01_sub"

---
# --- PersistentVolumeClaim (media/recordings) ---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: frigate-media
  namespace: home-security
  labels:
    app.kubernetes.io/name: frigate
    app.kubernetes.io/part-of: home-security
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: local-path

---
# --- Deployment ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frigate
  namespace: home-security
  labels:
    app.kubernetes.io/name: frigate
    app.kubernetes.io/component: nvr
    app.kubernetes.io/part-of: home-security
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: frigate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: frigate
        app.kubernetes.io/component: nvr
        app.kubernetes.io/part-of: home-security
    spec:
      containers:
        - name: frigate
          image: ghcr.io/blakeblackshear/frigate:stable
          ports:
            - name: web
              containerPort: 5000
              protocol: TCP
            - name: rtsp
              containerPort: 8554
              protocol: TCP
            - name: webrtc-tcp
              containerPort: 8555
              protocol: TCP
            - name: webrtc-udp
              containerPort: 8555
              protocol: UDP
          volumeMounts:
            - name: config
              mountPath: /config/config.yml
              subPath: config.yml
              readOnly: true
            - name: media
              mountPath: /media/frigate
            - name: dshm
              mountPath: /dev/shm
            - name: dri
              mountPath: /dev/dri
          env:
            - name: TZ
              value: America/Sao_Paulo
            - name: FRIGATE_MQTT_USER
              valueFrom:
                secretKeyRef:
                  name: mqtt-credentials
                  key: MQTT_USER
            - name: FRIGATE_MQTT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mqtt-credentials
                  key: MQTT_PASSWORD
          envFrom:
            - secretRef:
                name: frigate-cameras
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi
          securityContext:
            privileged: false
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop: ["ALL"]
              add: ["SYS_RAWIO"]
          livenessProbe:
            httpGet:
              path: /api/version
              port: web
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/version
              port: web
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: config
          configMap:
            name: frigate-config
        - name: media
          persistentVolumeClaim:
            claimName: frigate-media
        - name: dshm
          emptyDir:
            medium: Memory
            sizeLimit: 256Mi
        - name: dri
          hostPath:
            path: /dev/dri
            type: Directory
      # Schedule on node with Intel GPU
      nodeSelector:
        home-security/intel-gpu: "true"

---
# --- Service ---
apiVersion: v1
kind: Service
metadata:
  name: frigate
  namespace: home-security
  labels:
    app.kubernetes.io/name: frigate
    app.kubernetes.io/component: nvr
    app.kubernetes.io/part-of: home-security
spec:
  type: ClusterIP
  ports:
    - name: web
      port: 5000
      targetPort: web
      protocol: TCP
    - name: rtsp
      port: 8554
      targetPort: rtsp
      protocol: TCP
    - name: webrtc-tcp
      port: 8555
      targetPort: webrtc-tcp
      protocol: TCP
  selector:
    app.kubernetes.io/name: frigate
